version: 1.0
name: linkr
description: Linkr full-stack platform (Next.js frontend + Node/Prisma backend)

directories:
  frontend: ./frontend
  backend: ./backend
  shared: ./shared
  ops: ./ops

entrypoints:
  frontend:
    path: ./frontend
    type: nextjs
    build: npm run build
    start: npm start
  backend:
    path: ./backend
    type: node
    build: npm run build
    start: npm run start
    entrypoints:
  mobile:
    path: ./mobile
    type: react-native
    build: npx expo export

environment:
  node: "24.10.0"
  database: postgresql
  ports: [3000, 4000]

tasks:
  setup:
    - run: npm install --prefix backend
    - run: npm install --prefix frontend
    - run: npx prisma generate --prefix backend
    - tasks:
  mobile_build:
    - run: npx expo export --platform all --output dist

  migrate:
    - run: npx prisma migrate deploy --prefix backend

  backend_build:
    - run: npm run build --prefix backend

  frontend_build:
    - run: npm install --prefix frontend
    - run: NEXT_DISABLE_TURBOPACK=1 npm run build --prefix frontend

  build:
    - run: npm run build --prefix backend
    - run: NEXT_DISABLE_TURBOPACK=1 npm run build --prefix frontend

  deploy:
    - run: docker compose -f ops/docker-compose.yml up -d
